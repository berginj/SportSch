---
import { existsSync, readFileSync } from "node:fs";
import { resolve } from "node:path";

interface ApprovedImage {
  id: string;
  filename: string;
  alt?: string;
  width?: number;
  height?: number;
}

const approvedPath = resolve(process.cwd(), "public/images/candidates/approved-manifest.json");
let approved: ApprovedImage[] = [];

if (existsSync(approvedPath)) {
  try {
    const raw = readFileSync(approvedPath, "utf-8");
    const parsed = JSON.parse(raw);
    if (Array.isArray(parsed)) approved = parsed;
  } catch {
    approved = [];
  }
}

const heroImages = approved.slice(0, 3);
const gridImages = approved.slice(0, 12);
const highlightStrip = approved.slice(3, 8);
---

{
  approved.length > 0 && (
    <>
      <section class="container-shell pb-12">
        <article class="card overflow-hidden">
          <div class="grid gap-2 bg-slate-900 p-2 md:grid-cols-[1.35fr_1fr]">
            {
              heroImages[0] && (
                <figure class="relative m-0">
                  <img
                    src={`/images/candidates/${heroImages[0].filename}`}
                    alt={heroImages[0].alt || "AGSA action moment"}
                    class="h-[320px] w-full rounded-lg object-cover md:h-[420px]"
                    loading="eager"
                  />
                  <figcaption class="absolute bottom-2 left-2 rounded bg-black/55 px-3 py-1 text-xs font-semibold text-white">
                    AGSA Action
                  </figcaption>
                </figure>
              )
            }
            <div class="grid gap-2">
              {
                heroImages.slice(1).map((image) => (
                  <img
                    src={`/images/candidates/${image.filename}`}
                    alt={image.alt || "AGSA action moment"}
                    class="h-[206px] w-full rounded-lg object-cover"
                    loading="lazy"
                  />
                ))
              }
            </div>
          </div>
        </article>
      </section>

      <section class="container-shell pb-12">
        <div class="flex items-center justify-between gap-3">
          <h2 class="font-display text-3xl text-brand-secondary">Moments</h2>
          <p class="text-xs uppercase tracking-wide text-slate-500">Approved photo set</p>
        </div>
        <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {
            gridImages.map((image) => (
              <img
                src={`/images/candidates/${image.filename}`}
                alt={image.alt || "AGSA softball action photo"}
                class="h-52 w-full rounded-xl object-cover"
                loading="lazy"
              />
            ))
          }
        </div>
      </section>

      {
        highlightStrip.length > 0 && (
          <section class="container-shell pb-12">
            <article class="card p-4">
              <h2 class="font-display text-2xl text-brand-secondary">Season Highlights</h2>
              <div class="mt-3 grid gap-2 sm:grid-cols-2 md:grid-cols-5">
                {
                  highlightStrip.map((image) => (
                    <img
                      src={`/images/candidates/${image.filename}`}
                      alt={image.alt || "AGSA season highlight"}
                      class="h-28 w-full rounded-lg object-cover"
                      loading="lazy"
                    />
                  ))
                }
              </div>
            </article>
          </section>
        )
      }
    </>
  )
}
